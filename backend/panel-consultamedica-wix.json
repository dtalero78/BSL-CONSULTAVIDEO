import wixData from 'wix-data';
import wixStorage from 'wix-storage';
import wixWindow from 'wix-window';
import { sendTextMessage } from 'backend/WHATSAPP';

let documento = wixStorage.local.getItem("documentoParaLightbox");
let codEmpresa = wixStorage.local.getItem("codEmpresaParaLightbox");

// ==================================================
// CONFIGURACION DE VIDEOLLAMADAS
// ==================================================
const VIDEO_APP_DOMAIN = 'https://bsl-consultavideo-58jne.ondigitalocean.app';

/**
 * Genera un nombre √∫nico para la sala de video
 */
function generarNombreSala() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 7);
    return `consulta-${timestamp}-${random}`;
}

/**
 * Construye el link de videollamada para el paciente
 */
function construirLinkVideollamada(roomName, nombre, apellido, codMedico) {
    const params = new URLSearchParams({
        nombre: nombre.trim(),
        apellido: apellido.trim(),
        doctor: codMedico.trim()
    });
    return `${VIDEO_APP_DOMAIN}/patient/${roomName}?${params.toString()}`;
}

/**
 * Construye el link de videollamada para el doctor
 */
function construirLinkDoctor(roomName, codMedico) {
    return `${VIDEO_APP_DOMAIN}/doctor/${roomName}?doctor=${encodeURIComponent(codMedico.trim())}`;
}

async function fetchHistoriaClinica(documento) {
    try {
        let results = await wixData.query("HistoriaClinica").eq("numeroId", documento).find();
        if (results.items.length === 0) throw "No se encontr√≥ un registro en HistoriaClinica con ese documento.";

        let item = results.items[0];
        populateHistoriaClinicaFields(item);
        const telefonoConPrefijo = formatTelefono(item.celular);

        // Bot√≥n WhatsApp simple (#whp)
        const mensaje = `Hola ${item.nombre}. Te escribimos de BSL. Tienes una cita m√©dica programada conmigo`;
        const enlaceWhatsApp = `https://api.whatsapp.com/send?phone=${telefonoConPrefijo}&text=${encodeURIComponent(mensaje)}`;

        $w('#whp').link = enlaceWhatsApp;
        $w('#whp').target = "_blank";

        // Bot√≥n WhatsApp con videollamada (#whpTwilio)
        $w('#whpTwilio').onClick(async () => {
            // Generar sala SOLO cuando se hace clic
            const roomName = generarNombreSala();
            const linkVideollamadaPaciente = construirLinkVideollamada(
                roomName,
                item.primerNombre,
                item.primerApellido,
                codEmpresa
            );
            const linkVideollamadaDoctor = construirLinkDoctor(roomName, codEmpresa);

            const mensajeVideollamada = `Hola ${item.primerNombre}. Te escribimos de BSL.

Para tu consulta m√©dica, haz clic en el siguiente link:

${linkVideollamadaPaciente}

El link te conectar√° autom√°ticamente con el Dr. ${codEmpresa}.

Aseg√∫rate de permitir el acceso a tu c√°mara y micr√≥fono cuando el navegador te lo pida.

¬°Que tengas una excelente consulta!`;

            // Guardar el link del doctor
            wixStorage.local.setItem("linkVideollamadaDoctor", linkVideollamadaDoctor);
            wixStorage.local.setItem("roomNameActual", roomName);

            // Configurar el bot√≥n iniciarConsultaTwilio INMEDIATAMENTE con el link correcto
            $w('#iniciarConsultaTwilio').link = linkVideollamadaDoctor;
            $w('#iniciarConsultaTwilio').target = "_blank";

            // Formatear tel√©fono para sendTextMessage (sin el prefijo +)
            const telefonoSinPrefijo = telefonoConPrefijo.substring(1);

            // Enviar mensaje de WhatsApp usando la API de backend
            try {
                await sendTextMessage(telefonoSinPrefijo, mensajeVideollamada);
                console.log("Mensaje de videollamada enviado exitosamente");

                // Actualizar el campo de texto para indicar que el mensaje fue enviado
                $w('#estadoWhp').text = "‚úÖ MENSAJE ENVIADO";
                $w('#estadoWhp').show();
            } catch (error) {
                console.error("Error enviando mensaje de videollamada:", error);

                // Mostrar error en el campo de texto
                $w('#estadoWhp').text = "‚ùå ERROR AL ENVIAR";
                $w('#estadoWhp').show();
            }
        });

        return item;
    } catch (error) {
        console.error("Error en la consulta de HistoriaClinica:", error);
        throw error;
    }
}

async function fetchFormulario(documento) {
    try {
        let results = await wixData.query("FORMULARIO").eq("documentoIdentidad", documento).find();
        if (results.items.length === 0) throw "No se encontr√≥ un registro en FORMULARIO con ese documento.";

        let item = results.items[0];
        populateFormularioFields(item);

        return item;
    } catch (error) {
        console.error("Error en la consulta de FORMULARIO:", error);
        throw error;
    }
}

function populateHistoriaClinicaFields(item) {
    $w('#nombres').text = `${item.primerNombre || ""} ${item.primerApellido || ""}`;
    $w('#numeroId').text = item.numeroId || "";
    $w('#empresa').text = item.empresa || "";
    $w('#tipoExamen').text = item.tipoExamen || "";
    $w('#fechaConsulta').text = item.fechaAtencion ? item.fechaAtencion.toLocaleString() : "";
    $w('#examenes').text = item.examenes ? item.examenes.toString() : "";
    $w('#mdAntecedentes').value = item.mdAntecedentes || "";
    $w('#mdObsparaMidocya').value = item.mdObsParaMiDocYa || "";
    $w('#mdObservacionesCertificado').value = item.mdObservacionesCertificado || "";
    $w('#mdRecomendacionesMedicasAdicionales').value = item.mdRecomendacionesMedicasAdicionales || "";
    $w('#cargo').text = item.cargo || "";
    $w('#concepto').value = item.mdConceptoFinal || "";
    $w('#celular').text = item.celular || "No Registrado";
}

function populateFormularioFields(item) {
    $w('#profesion').text = item.profesion || "No especificado";
    $w('#foto').src = item.foto || "";
    $w('#edad').text = item.edad || "No especificado";
    $w('#genero').text = item.genero || "No especificado";
    $w('#licor').text = item.licor || "No especificado";
    $w('#ciudadDeResidencia').text = item.ciudadDeResidencia || "No especificado";
    $w('#estadoCivil').text = item.estadoCivil || "No especificado";
    $w('#hijos').text = item.hijos || "No especificado";
    $w('#ejercicio').text = item.ejercicio || "No especificado";
    $w('#encuesta').text = item.encuestaSalud ? item.encuestaSalud.toString() : "No especificado";
    $w('#historiaFamiliar').text = item.antecedentesFamiliares ? item.antecedentesFamiliares.toString() : "No especificado";
    $w('#cargoAnterior').text = item.empresa1 || "No especificado";
}

function formatTelefono(telefono) {
    telefono = telefono.replace(/\s+/g, '');
    if (telefono.startsWith('+57')) {
        return telefono;
    } else if (telefono.startsWith('57')) {
        return `+${telefono}`;
    } else {
        return `+57${telefono}`;
    }
}

async function modificarHistoriaClinica() {
    // üîπ Deshabilitar el bot√≥n mientras se procesa
    $w('#modificar').disable();
    $w('#loadingModificar').show();

    const today = new Date();

    try {
        let results = await wixData.query("HistoriaClinica").eq("numeroId", documento).find();
        if (results.items.length === 0) throw "No se encontr√≥ un registro con ese documento.";

        let item = results.items[0];
        updateHistoriaClinicaFields(item, today);

        let updatedItem = await wixData.update("HistoriaClinica", item);

        // üü® Enviar mensaje solo si es SITEL o KM2
        if (updatedItem.codEmpresa === "SITEL" || updatedItem.codEmpresa === "KM2") {
            await handleSITELorKM2Case(updatedItem);
        }

        // üü® Llamar a la app externa para generar el PDF si es RIPPLING
        if (updatedItem.codEmpresa === "RIPPLING") {
            $w('#modificar').label = "ESPERA! NO CIERRES LA VENTANA";

            const documentoId = updatedItem.numeroId;
            const nombreArchivo = `${updatedItem.primerNombre} ${updatedItem.primerApellido} ${updatedItem.numeroId}`;

            try {
                const res = await fetch("https://bsl-utilidades-yp78a.ondigitalocean.app/generar-pdf", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        documento: documentoId,
                        nombreArchivo,
                        codEmpresa: updatedItem.codEmpresa,
                        tipoExamen: updatedItem.tipoExamen
                    })
                });

                const data = await res.json();
                console.log("‚úÖ PDF generado y subido:", data);
            } catch (err) {
                console.error("‚ùå Error generando PDF:", err);
            } finally {
                $w('#modificar').label = "Guardar";
            }
        }

        // üìä Enviar reporte de consulta completada por WhatsApp
        await enviarReporteConsulta(updatedItem);

        wixWindow.lightbox.close();
    } catch (error) {
        console.error("Error actualizando el registro:", error);
    } finally {
        // üîπ Siempre reactivar el bot√≥n al final
        $w('#loadingModificar').hide();
        $w('#modificar').enable();
    }
}


function updateHistoriaClinicaFields(item, date) {
    item.mdAntecedentes = $w('#mdAntecedentes').value;
    item.mdObsParaMiDocYa = $w('#mdObsparaMidocya').value;
    item.mdObservacionesCertificado = $w('#mdObservacionesCertificado').value;
    item.mdRecomendacionesMedicasAdicionales = $w('#mdRecomendacionesMedicasAdicionales').value;
    item.cargo = $w('#cargo').text;
    item.mdConceptoFinal = $w('#concepto').value;
    item.mdDx1 = $w('#dx1').value;
    item.mdDx2 = $w('#dx2').value;
    item.fechaConsulta = date;
    item.atendido = "ATENDIDO";
    item.talla = $w('#talla').value;
    item.peso = $w('#peso').value;
}

async function handleSITELorKM2Case(item) {
    let results = await wixData.query("ADCTEST").eq("documento", item.numeroId).find();
    if (results.items.length > 0) return;

    const telefonoConPrefijo = formatTelefono(item.celular).substring(1);
    const phonePattern = /^57\d{10}$/;
    if (!phonePattern.test(telefonoConPrefijo)) throw 'N√∫mero de tel√©fono no v√°lido';

    let empresaNombre;
    if (item.codEmpresa === "SITEL") {
        empresaNombre = "FOUNDEVER";
    } else if (item.codEmpresa === "KM2") {
        empresaNombre = "KM2";
    } else if (item.codEmpresa === "SIIGO") {
        empresaNombre = "SIIGO";
    } else {
        throw "Empresa no reconocida";
    }

    await sendTextMessage(
        telefonoConPrefijo,
        `Hola! Est√°s realizando el examen m√©dico de ${empresaNombre} con nosotros. Debes terminar el siguiente link *urgente*: \n\nhttp://www.bsl.com.co/historia-clinica/${item.numeroId}`
    );
}

/**
 * üìä Enviar reporte detallado de consulta completada
 */
async function enviarReporteConsulta(item) {
    const timestamp = new Date().toLocaleString('es-CO', {
        timeZone: 'America/Bogota',
        hour12: false
    });

    // Construir reporte detallado
    let reporte = `üìã *CONSULTA COMPLETADA*\n`;
    reporte += `üìÖ ${timestamp}\n\n`;

    // Informaci√≥n del Paciente
    reporte += `üë§ *PACIENTE*\n`;
    reporte += `‚Ä¢ Nombre: ${item.primerNombre} ${item.primerApellido}\n`;
    reporte += `‚Ä¢ Documento: ${item.numeroId}\n`;
    reporte += `‚Ä¢ Celular: ${item.celular || 'No registrado'}\n\n`;

    // Informaci√≥n de la Empresa y Examen
    reporte += `üè¢ *EMPRESA Y EXAMEN*\n`;
    reporte += `‚Ä¢ Empresa: ${item.codEmpresa}\n`;
    reporte += `‚Ä¢ Tipo Examen: ${item.tipoExamen || 'No especificado'}\n`;
    reporte += `‚Ä¢ Cargo: ${item.cargo || 'No especificado'}\n\n`;

    // Informaci√≥n M√©dica
    reporte += `‚öïÔ∏è *M√âDICO*\n`;
    reporte += `‚Ä¢ C√≥digo: ${codEmpresa}\n\n`;

    // Datos Cl√≠nicos
    reporte += `üìä *DATOS CL√çNICOS*\n`;
    reporte += `‚Ä¢ Talla: ${item.talla || 'N/A'}\n`;
    reporte += `‚Ä¢ Peso: ${item.peso || 'N/A'}\n`;
    if (item.mdConceptoFinal) {
        reporte += `‚Ä¢ Concepto: ${item.mdConceptoFinal}\n`;
    }

    // Diagn√≥sticos
    if (item.mdDx1 || item.mdDx2) {
        reporte += `\nüîç *DIAGN√ìSTICOS*\n`;
        if (item.mdDx1) reporte += `‚Ä¢ DX1: ${item.mdDx1}\n`;
        if (item.mdDx2) reporte += `‚Ä¢ DX2: ${item.mdDx2}\n`;
    }

    // Observaciones importantes
    if (item.mdObservacionesCertificado) {
        reporte += `\nüìù *OBSERVACIONES*\n`;
        reporte += `${item.mdObservacionesCertificado.substring(0, 200)}${item.mdObservacionesCertificado.length > 200 ? '...' : ''}\n`;
    }

    try {
        // Enviar al n√∫mero del administrador
        await sendTextMessage('573008021701', reporte);
        console.log('‚úÖ Reporte de consulta enviado');
    } catch (error) {
        console.error('‚ùå Error enviando reporte de consulta:', error);
    }
}

$w.onReady(async function () {
    try {
        await fetchHistoriaClinica(documento);
        await fetchFormulario(documento);
    } catch (error) {
        console.error("Error al obtener los datos:", error);
    }

    $w("#modificar").onClick(modificarHistoriaClinica);

    // Configurar el campo iniciarConsultaTwilio para abrir la sala del doctor
    const linkVideollamadaDoctor = wixStorage.local.getItem("linkVideollamadaDoctor");

    if (linkVideollamadaDoctor) {
        $w('#iniciarConsultaTwilio').link = linkVideollamadaDoctor;
        $w('#iniciarConsultaTwilio').target = "_blank";
    }
});